<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Phishing Email Keyword Detection</title>
    <style>
      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
        margin: 0;
        padding: 0;
        min-height: 100vh;
      }
      .container {
        max-width: 430px;
        margin: 48px auto;
        background: #fff;
        padding: 36px 28px 28px 28px;
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(44, 62, 80, 0.12);
        position: relative;
        transition: box-shadow 0.2s;
      }
      .container:hover {
        box-shadow: 0 12px 40px rgba(44, 62, 80, 0.18);
      }
      h2 {
        text-align: center;
        margin-bottom: 28px;
        color: #007bff;
        letter-spacing: 1px;
        font-weight: 600;
      }
      label {
        font-weight: 500;
        margin-top: 14px;
        display: block;
        color: #34495e;
        font-size: 1.05em;
        margin-bottom: 4px;
      }
      input[type="text"],
      textarea,
      input[type="file"] {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 18px;
        border: 1px solid #bfc9d2;
        border-radius: 6px;
        font-size: 1em;
        background: #f8fafc;
        box-sizing: border-box;
        transition: border-color 0.2s;
      }
      input[type="text"]:focus,
      textarea:focus {
        border-color: #007bff;
        outline: none;
        background: #f0f6ff;
      }
      input[type="file"] {
        padding: 8px 12px;
        background: #f8fafc;
        color: #007bff;
        border-radius: 6px;
        border: 1px solid #bfc9d2;
      }
      button {
        width: 100%;
        padding: 12px;
        background: linear-gradient(90deg, #007bff 0%, #00c6ff 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 1.08em;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
        transition: background 0.2s;
        margin-top: 8px;
      }
      button:hover {
        background: linear-gradient(90deg, #0056b3 0%, #007bff 100%);
      }
      .result {
        margin-top: 24px;
        padding: 16px;
        border-radius: 8px;
        background: #e3f6ff;
        font-size: 1.13em;
        color: #007bff;
        border: 1px solid #b3e0ff;
        box-shadow: 0 2px 8px rgba(44, 62, 80, 0.04);
        text-align: center;
        font-weight: 500;
        letter-spacing: 0.5px;
      }
      .error {
        color: #d9534f;
        margin-top: 16px;
        text-align: center;
        font-weight: 500;
        font-size: 1.05em;
      }
      @media (max-width: 500px) {
        .container {
          max-width: 98vw;
          padding: 18px 8vw;
        }
        h2 {
          font-size: 1.3em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Phishing Email Keyword Detection</h2>
      <form id="emailForm">
        <label for="subject">Email Subject</label>
        <input type="text" id="subject" name="subject" required />

        <label for="body">Email Body</label>
        <textarea id="body" name="body" rows="6" required></textarea>

        <label for="emailFile">Or upload email file (.eml)</label>
        <input type="file" id="emailFile" accept=".eml" />

        <button type="submit">Check Email</button>
      </form>
      <div id="result" class="result" style="display: none"></div>
      <div id="error" class="error"></div>
    </div>

    <script>
      // Parse .eml file and extract subject and plain text body
      document.getElementById("emailFile").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            const emlText = evt.target.result;

            // Extract Subject line using regex
            const subjectMatch = emlText.match(/^Subject:\s*(.*)$/m);
            document.getElementById("subject").value = subjectMatch ? subjectMatch[1] : "";

            // Extract only the plain text part from multipart email
            // Find the plain text section by looking for 'Content-Type: text/plain'
            const plainTextMatch = emlText.match(/Content-Type:\s*text\/plain[^]*?(\r?\n\r?\n)([^]*?)(?=\r?\n--|$)/i);
            if (plainTextMatch) {
              // Remove quoted-printable encoding artifacts if present
              let body = plainTextMatch[2].replace(/=\r?\n/g, "").replace(/=3D/g, "=");
              document.getElementById("body").value = body.trim();
            } else {
              // Fallback: everything after first blank line
              const splitParts = emlText.split(/\r?\n\r?\n/);
              document.getElementById("body").value = splitParts.length > 1 ? splitParts.slice(1).join("\n\n") : "";
            }
          };
          reader.readAsText(file);
        }
      });

      document.getElementById("emailForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        document.getElementById("result").style.display = "none";
        document.getElementById("error").textContent = "";
        const subject = document.getElementById("subject").value;
        const body = document.getElementById("body").value;
        try {
          // Send POST request to Flask backend
          const response = await fetch("http://127.0.0.1:5000/detect_keywords", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ subject, body }),
          });
          if (!response.ok) throw new Error("Server error");
          const data = await response.json();

          // Show result in the frontend
          document.getElementById("result").innerHTML = `<strong>Risk Score:</strong> ${data.score}<br>
                   <strong>Label:</strong> ${data.label}`;
          document.getElementById("result").style.display = "block";
        } catch (err) {
          document.getElementById("error").textContent = "Error connecting to backend: " + err.message;
        }
      });
    </script>
  </body>
</html>
